TaskLinkedSystem = {
    -- Tasks com Action IDs únicos (49001-49022)
    tasks = {
        [49001] = {
            race = "Goblin", 
            monsters = {"Goblin", "Goblin Scavenger", "Goblin Assassin"}, 
            kills = 100, 
            reward = {
                exp = 15640, 
                items = {
                    {id = 2152, count = 30}, -- platinum coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49002] = {
            race = "Troll", 
            monsters = {"Troll", "Swamp Troll", "Frost Troll", "Island Troll"}, 
            kills = 2, 
            reward = {
                exp = 20000, 
                items = {
                    {id = 2152, count = 50}, -- platinum coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49003] = {
            race = "Rotworm", 
            monsters = {"Rotworm", "Carrion Worm"}, 
            kills = 4, 
            reward = {
                exp = 56400, 
                items = {
                    {id = 2160, count = 1}, -- crystal coin
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49004] = {
            race = "Minotaur", 
            monsters = {"Minotaur", "Minotaur Archer", "Minotaur Guard", "Minotaur Mage"}, 
            kills = 200, 
            reward = {
                exp = 56400, 
                items = {
                    {id = 2160, count = 1}, -- crystal coin
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49005] = {
            race = "Dwarf", 
            monsters = {"Dwarf", "Dwarf Soldier", "Dwarf Guard", "Dwarf Geomancer"}, 
            kills = 300, 
            reward = {
                exp = 80000, 
                items = {
                    {id = 2160, count = 1}, -- crystal coin
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49006] = {
            race = "Dworcs", 
            monsters = {"Dworc Venomsniper", "Dworc Voodoomaster", "Dworc Fleshhunter"}, 
            kills = 300, 
            reward = {
                exp = 100000, 
                items = {
                    {id = 2160, count = 1}, -- crystal coin
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49007] = {
            race = "Elf", 
            monsters = {"Elf", "Elf Scout", "Elf Arcanist"}, 
            kills = 400, 
            reward = {
                exp = 56400, 
                items = {
                    {id = 2160, count = 3}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49008] = {
            race = "Dark Cathedral", 
            monsters = {"Dark Apprentice", "Dark Magician", "Dark Monk", "Assassin"}, 
            kills = 400, 
            reward = {
                exp = 156400, 
                items = {
                    {id = 2160, count = 4}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49009] = {
            race = "Tombs", 
            monsters = {"Ghost", "Mummy", "Ghoul", "Demon Skeleton", "Skeleton", "Crypt Shambler"}, 
            kills = 564, 
            reward = {
                exp = 156400, 
                items = {
                    {id = 2160, count = 5}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49010] = {
            race = "Scarab", 
            monsters = {"Scarab"}, 
            kills = 300, 
            reward = {
                exp = 156400, 
                items = {
                    {id = 2160, count = 5}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49011] = {
            race = "Cyclops", 
            monsters = {"Cyclops", "Cyclops Smith", "Cyclops Drone"}, 
            kills = 564, 
            reward = {
                exp = 256400, 
                items = {
                    {id = 2160, count = 5}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49012] = {
            race = "Mutated Humans", 
            monsters = {"Mutated Human"}, 
            kills = 300, 
            reward = {
                exp = 156400, 
                items = {
                    {id = 2160, count = 5}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49013] = {
            race = "Coryms", 
            monsters = {"Corym Charlatan", "Corym Skirmisher", "Corym Vanguard"}, 
            kills = 400, 
            reward = {
                exp = 300000, 
                items = {
                    {id = 2160, count = 7}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49014] = {
            race = "Banuta Surface", 
            monsters = {"Kongra", "Sibang", "Merklin"}, 
            kills = 564, 
            reward = {
                exp = 300000, 
                items = {
                    {id = 2160, count = 5}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49015] = {
            race = "Pirates", 
            monsters = {"Pirate Marauder", "Pirate Cutthroat", "Pirate Corsair", "Pirate Buccaneer"}, 
            kills = 564, 
            reward = {
                exp = 300000, 
                items = {
                    {id = 2160, count = 5}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49016] = {
            race = "Barbarians", 
            monsters = {"Barbarian Bloodwalker", "Barbarian Brutetamer", "Barbarian Headsplitter", "Barbarian Skullhunter"}, 
            kills = 700, 
            reward = {
                exp = 300000, 
                items = {
                    {id = 2160, count = 10}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49017] = {
            race = "Djinn", 
            monsters = {"Marid", "Efreet", "Green Djinn", "Blue Djinn"}, 
            kills = 200, 
            reward = {
                exp = 300000, 
                items = {
                    {id = 2160, count = 5}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49018] = {
            race = "Stonerefiner", 
            monsters = {"Stonerefiner"}, 
            kills = 800, 
            reward = {
                exp = 400000, 
                items = {
                    {id = 2160, count = 15}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49019] = {
            race = "Dragon", 
            monsters = {"Dragon", "Dragon Hatchling"}, 
            kills = 200, 
            reward = {
                exp = 564000, 
                items = {
                    {id = 2160, count = 10}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49020] = {
            race = "Oramond", 
            monsters = {"Minotaur Hunter", "Mooh Tah Warrior", "Minotaur Amazon", "Worm Priestess", "Execowtioner", "Moohtant"}, 
            kills = 564, 
            reward = {
                exp = 800000, 
                items = {
                    {id = 2160, count = 15}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49021] = {
            race = "Quara", 
            monsters = {"Quara Mantassin", "Quara Constrictor", "Quara Pincher", "Quara Predator", "Quara Hydromancer"}, 
            kills = 1000, 
            reward = {
                exp = 1000000, 
                items = {
                    {id = 2160, count = 20}, -- crystal coins
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        },
        [49022] = {
            race = "Ancient Scarab", 
            monsters = {"Ancient Scarab"}, 
            kills = 564, 
            reward = {
                exp = 1000000, 
                items = {
                    {id = 2160, count = 1}, -- crystal coin
                    {id = 15515, count = 5} -- gold bar coins
                }
            }
        }
    },

    -- Configuração das salas (apenas 1 sala de recompensa final)
    rooms = {
        {
            chestPos = Position(32243, 32189, 7), -- ATUALIZE ESTA POSIÇÃO
            chestActionId = Storage.TaskLinked.chestActionId,
            requiredTasks = 22, -- Todas as 22 tasks devem ser completadas
            finalReward = {
                exp = 5000000,
                items = {
                    {id = 2160, count = 50},  
                    {id = 15515, count = 100}
                }
            }
        }
    },

    monsterToTask = {}
}

for actionId, task in pairs(TaskLinkedSystem.tasks) do
    for _, monster in ipairs(task.monsters) do
        TaskLinkedSystem.monsterToTask[monster:lower()] = actionId
    end
end

function TaskLinkedSystem.getTaskNumber(actionId)
    return actionId - 49000
end

function TaskLinkedSystem.getPreviousTask(taskNumber)
    local prevActionId = 49000 + (taskNumber - 1)
    return TaskLinkedSystem.tasks[prevActionId]
end

function TaskLinkedSystem.isTaskActive(player, taskNumber)
    return player:getStorageValue(Storage.TaskLinked.activeTaskStorage + taskNumber) == 1
end

function TaskLinkedSystem.activateTask(player, taskNumber)
    player:setStorageValue(Storage.TaskLinked.activeTaskStorage + taskNumber, 1)
end

function TaskLinkedSystem.canStartTask(player, taskNumber)
    if taskNumber == 1 then return true end
    
    local prevStorage = Storage.TaskLinked.storageBase + (taskNumber - 1)
    local prevTask = TaskLinkedSystem.tasks[49000 + (taskNumber - 1)]
    
    if not prevTask then return false end
    
    return player:getStorageValue(prevStorage) >= prevTask.kills
end

Game.sendConsoleMessage("Task Linked System loaded with " .. #TaskLinkedSystem.tasks .. " tasks", CONSOLEMESSAGE_TYPE_INFO)